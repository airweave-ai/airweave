<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background-color: #f5f5f3;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 780px;
      }

      .logo {
        width: 100px;
        height: 100px;
        margin-bottom: 80px;
        border-radius: 12px;
      }

      .chat-input-container {
        width: 100%;
        background: white;
        border-radius: 28px;
        padding: 20px 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .input-row {
        display: flex;
        align-items: center;
        width: 100%;
        margin-bottom: 16px;
      }

      .chat-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 18px;
        color: #333;
        background: transparent;
      }

      .chat-input::placeholder {
        color: #9ca3af;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon-btn {
        width: 44px;
        height: 44px;
        border: 1px solid #e8e8e6;
        border-radius: 12px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
      }

      .icon-btn img {
        width: 24px;
        height: 24px;
        border-radius: 4px;
      }

      .icon-btn.plus {
        font-size: 22px;
        color: #9ca3af;
        font-weight: 300;
      }

      .apps-btn {
        display: flex;
        align-items: center;
        padding: 0 12px 0 0;
        border: 1px solid #e8e8e6;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        font-size: 15px;
        color: #1f2937;
        font-weight: 400;
        height: 44px;
      }

      .apps-btn .plus-icon {
        width: 44px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: #9ca3af;
        font-weight: 300;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        color: #1f2937;
        font-weight: 400;
      }

      .action-btn svg {
        width: 18px;
        height: 18px;
        color: #4b5563;
      }

      .spacer {
        flex: 1;
      }

      .mic-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #1a1a1a;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .mic-btn svg {
        width: 20px;
        height: 20px;
        color: white;
      }

      /* Modal styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.open {
        display: flex;
      }

      .modal-content {
        position: relative;
        width: 90%;
        max-width: 360px;
        height: 80%;
        max-height: 540px;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: background 0.2s;
      }

      .modal-close:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      #connectFrame {
        width: 100%;
        height: 100%;
        border: none;
      }

      .logo {
        box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.1);
      }

      /* Log toolbar styles */
      .log-toolbar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 1001;
      }

      .log-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
      }

      .log-header h3 {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin: 0;
        cursor: pointer;
        user-select: none;
      }

      .log-toggle {
        font-size: 14px;
        color: #6b7280;
        width: 20px;
        text-align: center;
        cursor: pointer;
        user-select: none;
      }

      .log-buttons {
        display: flex;
        gap: 6px;
        flex: 1;
      }

      .state-btn {
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .state-btn:hover {
        opacity: 0.85;
      }

      .state-btn.success {
        background: #dcfce7;
        color: #166534;
      }

      .state-btn.loading {
        background: #e5e7eb;
        color: #374151;
      }

      .state-btn.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .state-btn.warning {
        background: #fef3c7;
        color: #92400e;
      }

      .state-btn.active {
        outline: 2px solid #3b82f6;
        outline-offset: 1px;
      }

      .log-content {
        max-height: 80px;
        overflow-y: auto;
        padding: 6px 8px;
        font-family: monospace;
        font-size: 11px;
      }

      .log-content.collapsed {
        display: none;
      }

      .log-entry {
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 3px;
      }

      .log-entry:last-child {
        margin-bottom: 0;
      }

      .log-entry.sent {
        background: #e0f2fe;
        color: #0369a1;
      }

      .log-entry.received {
        background: #dcfce7;
        color: #166534;
      }

      .log-entry.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .log-entry.info {
        background: #fef9c3;
        color: #854d0e;
      }

      body {
        padding-bottom: 140px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img
        src="https://avatars.githubusercontent.com/u/14957082?s=200&v=4"
        alt="Logo"
        class="logo"
        class="logo"
      />

      <div class="chat-input-container">
        <div class="input-row">
          <input type="text" class="chat-input" placeholder="Ask anything..." />
        </div>

        <div class="toolbar">
          <button class="apps-btn">
            <span class="plus-icon">+</span>
            Apps
          </button>

          <div class="spacer"></div>

          <button class="mic-btn">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" />
              <path d="M19 10v2a7 7 0 01-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal-content">
        <button class="modal-close" id="modalClose">&times;</button>
        <iframe id="connectFrame"></iframe>
      </div>
    </div>

    <!-- Log Toolbar -->
    <div class="log-toolbar">
      <div class="log-header">
        <h3 onclick="toggleLog()">Logs</h3>
        <div class="log-buttons">
          <button
            class="state-btn success active"
            onclick="setResponseMode('auto')"
            id="btn-auto"
          >
            Auto
          </button>
          <button
            class="state-btn loading"
            onclick="setResponseMode('loading')"
            id="btn-loading"
          >
            Loading
          </button>
          <button
            class="state-btn error"
            onclick="setResponseMode('error-invalid')"
            id="btn-error-invalid"
          >
            Invalid Token
          </button>
          <button
            class="state-btn error"
            onclick="setResponseMode('error-expired')"
            id="btn-error-expired"
          >
            Expired Token
          </button>
          <button
            class="state-btn warning"
            onclick="setResponseMode('error-network')"
            id="btn-error-network"
          >
            Network Error
          </button>
        </div>
        <span class="log-toggle" id="logToggle" onclick="toggleLog()">−</span>
      </div>
      <div class="log-content" id="logContent">
        <div class="log-entry info">Ready. Click "Apps" to start.</div>
      </div>
    </div>

    <script>
      // Configuration
      const CONFIG = {
        API_URL: "http://localhost:8001",
        API_KEY: "test",
        COLLECTION_ID: "test-16c0r8",
        END_USER_ID: "anand",
        SESSION_MODE: "all",
        CONNECT_URL: "http://localhost:5173?theme=light",
      };

      let sessionToken = null;
      let responseMode = "auto";

      // Response mode handling
      function setResponseMode(mode) {
        responseMode = mode;
        // Update active button
        document
          .querySelectorAll(".state-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document.getElementById(`btn-${mode}`).classList.add("active");
        log(`Response mode set to: ${mode}`, "info");
      }

      // Log functions
      function log(message, type = "info") {
        const logContent = document.getElementById("logContent");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContent.appendChild(entry);
        logContent.scrollTop = logContent.scrollHeight;
      }

      function toggleLog() {
        const logContent = document.getElementById("logContent");
        const logToggle = document.getElementById("logToggle");
        logContent.classList.toggle("collapsed");
        logToggle.textContent = logContent.classList.contains("collapsed")
          ? "+"
          : "−";
      }

      // Handle token request based on response mode
      function handleTokenRequest(requestId) {
        const iframe = document.getElementById("connectFrame");
        if (!iframe || !iframe.contentWindow) return;

        const theme = { mode: "light" };

        switch (responseMode) {
          case "auto":
            if (sessionToken) {
              iframe.contentWindow.postMessage(
                {
                  type: "TOKEN_RESPONSE",
                  requestId,
                  token: sessionToken,
                  theme,
                },
                "*",
              );
              log(
                `Sent: TOKEN_RESPONSE (token: ${sessionToken.substring(0, 20)}...)`,
                "sent",
              );
            } else {
              iframe.contentWindow.postMessage(
                { type: "TOKEN_ERROR", requestId, error: "No token available" },
                "*",
              );
              log("Sent: TOKEN_ERROR - No token available", "error");
            }
            break;

          case "loading":
            log("Not responding (testing loading state)...", "info");
            // Don't respond - let it timeout
            break;

          case "error-invalid":
            iframe.contentWindow.postMessage(
              {
                type: "TOKEN_RESPONSE",
                requestId,
                token: "invalid-token-format",
                theme,
              },
              "*",
            );
            log("Sent: Invalid token format", "sent");
            break;

          case "error-expired":
            const expiredPayload = btoa(
              JSON.stringify({
                sid: "expired-session-id",
                exp: Date.now() - 10000,
              }),
            );
            iframe.contentWindow.postMessage(
              {
                type: "TOKEN_RESPONSE",
                requestId,
                token: `${expiredPayload}.fakesignature`,
                theme,
              },
              "*",
            );
            log("Sent: Expired token", "sent");
            break;

          case "error-network":
            const networkPayload = btoa(
              JSON.stringify({ sid: "network-error-test" }),
            );
            iframe.contentWindow.postMessage(
              {
                type: "TOKEN_RESPONSE",
                requestId,
                token: `${networkPayload}.fakesignature`,
                theme,
              },
              "*",
            );
            log("Sent: Token that will cause network error", "sent");
            break;
        }
      }

      // Fetch session token from API
      async function fetchSessionToken() {
        log("Fetching session token...", "info");
        const response = await fetch(`${CONFIG.API_URL}/connect/sessions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": CONFIG.API_KEY,
          },
          body: JSON.stringify({
            readable_collection_id: CONFIG.COLLECTION_ID,
            mode: CONFIG.SESSION_MODE,
            end_user_id: CONFIG.END_USER_ID,
          }),
        });
        const data = await response.json();
        log(
          `Session token received (session_id: ${data.session_id})`,
          "received",
        );
        return data.session_token;
      }

      // Open modal and load iframe
      async function openModal() {
        try {
          log("Opening Connect modal...", "info");
          sessionToken = await fetchSessionToken();
          const modal = document.getElementById("modalOverlay");
          const iframe = document.getElementById("connectFrame");

          modal.classList.add("open");
          iframe.src = CONFIG.CONNECT_URL;
          log("Connect iframe loaded", "sent");
        } catch (error) {
          console.error("Failed to fetch session token:", error);
          log(`Failed to fetch session token: ${error.message}`, "error");
          alert("Failed to connect. Please try again.");
        }
      }

      // Close modal
      function closeModal() {
        const modal = document.getElementById("modalOverlay");
        const iframe = document.getElementById("connectFrame");

        modal.classList.remove("open");
        iframe.src = "";
        sessionToken = null;
        log("Connect modal closed", "info");
      }

      // Handle messages from Connect iframe
      window.addEventListener("message", (event) => {
        const { data } = event;

        if (!data || typeof data !== "object" || !data.type) {
          return;
        }

        switch (data.type) {
          case "CONNECT_READY":
            log("Received: CONNECT_READY - iframe is ready", "received");
            break;

          case "REQUEST_TOKEN":
            log(
              `Received: REQUEST_TOKEN (requestId: ${data.requestId})`,
              "received",
            );
            handleTokenRequest(data.requestId);
            break;

          case "STATUS_CHANGE":
            log(
              `Received: STATUS_CHANGE - ${JSON.stringify(data.status)}`,
              "received",
            );
            break;

          case "CONNECTION_CREATED":
            log(
              `Received: CONNECTION_CREATED (connectionId: ${data.connectionId})`,
              "received",
            );
            break;

          case "CLOSE":
            log(`Received: CLOSE (reason: ${data.reason})`, "received");
            closeModal();
            break;
        }
      });

      // Event listeners
      document.querySelector(".apps-btn").addEventListener("click", openModal);
      document
        .getElementById("modalClose")
        .addEventListener("click", closeModal);
      document.getElementById("modalOverlay").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) {
          closeModal();
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
        }
      });
    </script>
  </body>
</html>
